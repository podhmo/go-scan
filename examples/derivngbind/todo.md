# derivngbind TODO

## 実現できたこと

-   `@derivng:binding` アノテーションを持つ構造体に対して `Bind(req *http.Request) error` メソッドを生成する基本的な仕組みを実装しました。
-   フィールドタグによるバインディングソースの指定:
    -   `in:"<type>"` (type: `query`, `header`, `cookie`, `path`, `body`)
    -   `<type>:"<name>"` (例: `query:"id"`, `header:"X-Token"`, `path:"userID"`, `cookie:"session"`)
-   リクエストのクエリパラメータ、ヘッダー、クッキーからの値のバインディングを実装しました。
    -   対応型: `string`, `int`, `bool` (非ポインタ)。
    -   型変換エラーハンドリング。
-   リクエストボディ (JSON) からのバインディング:
    -   構造体全体をボディの対象とする場合（構造体のDocコメントに `@derivng:binding in:"body"`）。
    -   特定のフィールドをボディの対象とする場合（フィールドタグ `in:"body"`）。
    -   `encoding/json` を利用したデコード。
-   Pathパラメータのバインディングについて、`Bind` メソッドが `pathVar func(string) string` を引数に取り、それを利用して値を取得する方式に変更しました。これにより、Goのバージョンや特定のルーターライブラリへの依存がなくなりました。
-   必要な標準パッケージのインポート文を自動生成します。
-   基本的なテストケース (`testdata/simple/models.go`, `testdata/simple/models_test.go`) と `Makefile` を整備しました。
-   ドキュメント (`README.md`, `docs/ja/from-derivngbind.md`) を作成しました。
-   非ポインタフィールドに対する `required:"true"` タグの基本的な実装を追加しました。指定されたフィールドがリクエストに存在しない場合、エラーを返すようになります。
-   クエリパラメータにおいて、キーが存在するが値が空文字列の場合の挙動を改善しました。`string` 型以外のフィールドでは、空文字列が指定されると型変換エラーとして扱われます。
-   ポインタ型フィールド (`*string`, `*int`, `*bool`) の基本的なバインディングと `required:"true"` タグに対応しました。`go-scan` の `FieldType.Name` と `FieldType.IsPointer` を利用して要素型名を取得しています。
-   オプショナルなポインタ型フィールド (`*int`, `*bool`) で型変換不能な値（例: 空文字列）が指定された場合、エラーとせずに `nil` を設定するように修正しました。

## 残りの作業・実現見込み

### 高優先度

<!-- 1. Pathパラメータ処理の完全なテスト: (この項目は pathVar func の導入により達成または性質が変化しました) -->
    <!-- * 現状、Go 1.22環境での `req.PathValue()` を利用したPathパラメータのバインディングが正しく機能するかのテストがサンドボックス環境の制約で実施できていません。 -->
    <!-- * ローカル環境やCI環境でGo 1.22以上を指定してテストを実行し、動作を保証する必要があります。 -->
    <!-- * Go 1.21環境で `chi` などのルーターと連携する場合のPathパラメータ取得方法（例: context経由）のサポートも検討の余地があります（ただし、標準ライブラリへの追従を優先）。 -->

1.  **ポインタ型への対応**: (基本的な対応完了)
    *   クエリ、ヘッダー、クッキー、パスパラメータについて、`*string`, `*int`, `*bool` のようなポインタ型フィールドへのバインディングを実装しました。
    *   値が存在しない場合や、オプショナルな場合に型変換できない値が来た場合は `nil` を設定し、存在すればデリファレンスして値を設定するロジックを実装しました。
    *   `go-scan` の `FieldType.Name` (要素型名を返す) と `FieldType.IsPointer` (ポインタかどうかのフラグ) を利用して対応しました。

### 中優先度

3.  **対応型の拡充**:
    *   `int64`, `float32`, `float64` などの数値型。
    *   `time.Time` (特定のフォーマット文字列からのパース)。
    *   スライス型 (例: `[]string`, `[]int` from query parameters like `?ids=1,2,3` or `?ids=1&ids=2`)。

4.  **エラーハンドリングの改善**:
    *   複数のバインディングエラーが発生した場合に、それらをまとめて返す (multierror的な)。 (Go 1.20+ の `errors.Join` を使用して対応済み)
    *   どのフィールドでどのようなエラーが起きたか、より詳細なエラー情報を提供。
    *   **残課題**:
        *   Cookie の `required` エラーについて、`http.ErrNoCookie` と値が空の場合の区別などの詳細なエラー報告が一時的に単純化されているため、再実装が必要です。
        *   Header, Path, Cookie ソースにおける「キー非存在」と「キーは存在するが値が空」の場合の挙動の精密化（Query との統一性）。

5.  **設定オプションの導入**:
    *   タグやアノテーションで、フィールドが必須であるか (`required`)、デフォルト値、バリデーションルールなどを指定できるようにする。 (`required` について対応済み)
    *   必須フィールドが欠落している場合にエラーとする。 (`required` について対応済み)

6.  **生成コードの最適化**:
    *   不要なエラー変数の宣言を避けるなど、よりクリーンなコードを生成する。

### 低優先度

7.  **外部パッケージ型のサポートの明確化**:
    *   `field.Type.String()` で型名は取得できていますが、生成コードで外部パッケージの型を正しく扱うためのインポート管理の堅牢性向上。

8.  **ドキュメント・使用例の拡充**:
    *   より複雑なユースケースを含むサンプルコードの追加。
    *   `pathVar func(string) string` を一般的なHTTPルーター (例: `net/http` の標準 `ServeMux` (Go 1.22+), `chi`, `gin` など) と連携させる方法の具体例をドキュメントに追加。

## 実現見込みについて

-   **高優先度**の項目は、既存のアーキテクチャの範囲内で比較的早期に実現可能と考えられます。ポインタ対応はテンプレートと型処理ロジックの追加で対応できます。Pathパラメータの扱いは `pathVar` 関数の導入により、ジェネレータ側の責務は明確化されました。
-   **中優先度**の項目は、型の種類に応じたパーサー/コンバーターの追加や、エラー処理の共通化など、設計と実装にある程度の工数が必要です。設定オプションはタグ解析の拡張とテンプレートへの反映が主となります。
-   **低優先度**の項目は、既存機能の改善やドキュメント整備であり、継続的に対応していくものです。

この `todo.md` をもとに、今後の開発を進めていくことを想定しています。
